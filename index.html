<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Skyrim Quest Log</title>
    <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;700&family=MedievalSharp&display=swap" rel="stylesheet">
    <style>
        :root {
            --skyrim-gold: #c4b07b;
            --skyrim-iron: #2a2a2a;
            --skyrim-bg: #0b0c0d;
            --xp-bar: #4a90e2;
        }

        body {
            margin: 0;
            padding: 0;
            font-family: 'Cinzel', serif;
            background: var(--skyrim-bg) url('https://images.alphacoders.com/203/thumb-1920-203543.jpg') no-repeat center center fixed;
            background-size: cover;
            color: #e0e0e0;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
        }

        .overlay {
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0, 0, 0, 0.7);
            z-index: -1;
        }

        .container {
            width: 90%;
            max-width: 500px;
            background: rgba(20, 20, 20, 0.92);
            border: 2px solid var(--skyrim-gold);
            padding: 30px;
            box-shadow: 0 0 30px rgba(0,0,0,1);
            border-radius: 2px;
        }

        h1, h2 { text-align: center; color: var(--skyrim-gold); text-transform: uppercase; letter-spacing: 2px; margin-top: 0; }

        /* Stats do Jogador */
        .player-stats {
            background: rgba(255, 255, 255, 0.05);
            padding: 15px;
            border: 1px solid rgba(196, 176, 123, 0.3);
            margin-bottom: 20px;
            position: relative;
        }

        .user-header { display: flex; justify-content: space-between; align-items: baseline; margin-bottom: 5px; }
        .hero-name { color: white; font-size: 1.1em; text-shadow: 1px 1px 2px black; }
        .rank-title { color: var(--skyrim-gold); font-weight: bold; font-size: 1em; }
        
        .xp-container {
            width: 100%;
            height: 12px;
            background: #111;
            border: 1px solid #444;
            margin-top: 10px;
            position: relative;
        }

        #xp-fill {
            height: 100%;
            background: linear-gradient(90deg, #1e3c72, var(--xp-bar));
            width: 0%;
            transition: width 0.6s cubic-bezier(0.17, 0.67, 0.83, 0.67);
            box-shadow: 0 0 10px var(--xp-bar);
        }

        /* Inputs e Botões */
        input {
            width: 100%;
            padding: 12px;
            margin: 10px 0;
            background: #1a1a1a;
            border: 1px solid #444;
            color: white;
            box-sizing: border-box;
            font-family: 'MedievalSharp', cursive;
        }

        button {
            width: 100%;
            padding: 12px;
            background: transparent;
            border: 1px solid var(--skyrim-gold);
            color: var(--skyrim-gold);
            cursor: pointer;
            text-transform: uppercase;
            font-weight: bold;
            transition: 0.3s;
            font-family: 'Cinzel', serif;
        }

        button:hover { background: var(--skyrim-gold); color: black; }

        /* Lista de Quests */
        ul { list-style: none; padding: 0; margin-top: 20px; }
        
        .task-item {
            background: rgba(255, 255, 255, 0.03);
            margin-bottom: 10px;
            padding: 12px;
            border-left: 3px solid var(--skyrim-gold);
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: 0.3s;
        }

        .task-content { display: flex; align-items: center; gap: 15px; cursor: pointer; flex-grow: 1; }
        .check-box { 
            width: 20px; height: 20px; border: 1px solid var(--skyrim-gold); 
            display: flex; align-items: center; justify-content: center; font-size: 0.8em;
        }

        .task-item.completed { border-left-color: #4CAF50; background: rgba(76, 175, 80, 0.05); }
        .task-item.completed .task-text { text-decoration: line-through; color: #888; }
        .task-item.completed .check-box { background: var(--skyrim-gold); color: black; }

        .btn-delete { width: auto; padding: 5px 12px; border-color: #ff4444; color: #ff4444; margin-left: 10px; }
        .btn-delete:hover { background: #ff4444; color: white; }

        #login-error { color: #ff4444; font-size: 0.9em; text-align: center; margin-top: 10px; }
    </style>
</head>
<body>
    <div class="overlay"></div>

    <div class="container">
        <div id="login-section">
            <h1>Skyrim Quest Log</h1>
            <input type="text" id="username" placeholder="Nome do Herói">
            <input type="password" id="password" placeholder="Grito de Guerra (Senha)">
            <button onclick="login()">Entrar no Reino</button>
            <p id="login-error"></p>
        </div>

        <div id="task-section" style="display: none;">
            <div class="player-stats">
                <div class="user-header">
                    <span class="hero-name" id="display-username">Dovahkiin</span>
                    <span id="user-rank" class="rank-title">Prisioneiro</span>
                </div>
                <div style="font-size: 0.8em; color: #aaa;">Nível: <span id="user-level" style="color: white;">1</span></div>
                <div class="xp-container">
                    <div id="xp-fill"></div>
                </div>
            </div>

            <h2>Diário de Quests</h2>
            <div style="display: flex; gap: 5px;">
                <input type="text" id="task-title" placeholder="Nova Missão...">
                <button onclick="createTask()" style="width: 60px;">+</button>
            </div>

            <ul id="task-list"></ul>
            <button onclick="logout()" style="margin-top: 20px; border-color: #555; color: #888; font-size: 0.8em;">Abandonar Partida</button>
        </div>
    </div>

    <script>
        const API_URL = (window.location.hostname === "localhost" || window.location.hostname === "127.0.0.1") 
                ? "http://localhost:8080" 
                : window.location.origin;

        let token = localStorage.getItem("token");

        document.addEventListener('DOMContentLoaded', () => {
            if (token) {
                loadTasks();
            }
        });

        async function login() {
            const u = document.getElementById("username").value;
            const p = document.getElementById("password").value;
            const err = document.getElementById("login-error");

            try {
                const res = await fetch(`${API_URL}/login`, {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ username: u, password: p })
                });
                const data = await res.json();

                if (res.ok) {
                    localStorage.setItem("token", data.token);
                    localStorage.setItem("username", u); // Salva o nome para exibir depois
                    token = data.token;
                    loadTasks();
                } else {
                    err.innerText = data.error || "Credenciais inválidas.";
                }
            } catch (e) {
                err.innerText = "O servidor não respondeu. Verifique sua conexão.";
            }
        }

        async function loadTasks() {
            try {
                const res = await fetch(`${API_URL}/tasks/`, {
                    headers: { "Authorization": `Bearer ${token}` }
                });

                if (res.status === 401) return logout();

                const data = await res.json();
                
                document.getElementById("login-section").style.display = 'none';
                document.getElementById("task-section").style.display = 'block';

                // Atualiza Interface com dados do Usuário
                if (data.user) {
                    document.getElementById("display-username").innerText = localStorage.getItem("username");
                    document.getElementById("user-level").innerText = data.user.level;
                    document.getElementById("user-rank").innerText = data.user.rank;
                    document.getElementById("xp-fill").style.width = data.user.xp + "%";
                }

                // Renderiza Lista de Tasks
                const list = document.getElementById("task-list");
                list.innerHTML = "";
                
                // Note: Verifique se seu Go retorna "tasks" ou "Tasks" (depende da struct/JSON tags)
                const tasks = data.tasks || [];
                
                tasks.forEach(t => {
                    const li = document.createElement('li');
                    li.className = `task-item ${t.done ? 'completed' : ''}`;
                    li.innerHTML = `
                        <div class="task-content" onclick="toggleTask(${t.ID}, ${t.done})">
                            <div class="check-box">${t.done ? '✔' : ''}</div>
                            <span class="task-text">${t.title}</span>
                        </div>
                        <button class="btn-delete" onclick="deleteTask(${t.ID})">X</button>
                    `;
                    list.appendChild(li);
                });
            } catch (e) {
                console.error("Erro ao carregar quests:", e);
            }
        }

        async function createTask() {
            const input = document.getElementById("task-title");
            if (!input.value) return;
            try {
                await fetch(`${API_URL}/tasks/`, {
                    method: "POST",
                    headers: { 
                        "Content-Type": "application/json",
                        "Authorization": `Bearer ${token}` 
                    },
                    body: JSON.stringify({ title: input.value, done: false })
                });
                input.value = "";
                loadTasks();
            } catch (e) { console.error(e); }
        }

        async function toggleTask(id, currentStatus) {
            try {
                await fetch(`${API_URL}/tasks/${id}`, {
                    method: "PUT",
                    headers: { 
                        "Content-Type": "application/json",
                        "Authorization": `Bearer ${token}` 
                    },
                    body: JSON.stringify({ done: !currentStatus })
                });
                loadTasks(); 
            } catch (e) { console.error(e); }
        }

        async function deleteTask(id) {
            if(!confirm("Deseja realmente abandonar esta quest?")) return;
            try {
                await fetch(`${API_URL}/tasks/${id}`, {
                    method: "DELETE",
                    headers: { "Authorization": `Bearer ${token}` }
                });
                loadTasks();
            } catch (e) { console.error(e); }
        }

        function logout() {
            localStorage.clear();
            location.reload();
        }
    </script>
</body>
</html>