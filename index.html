<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Skyrim Quest Log</title>
    <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;700&family=MedievalSharp&display=swap" rel="stylesheet">
    <style>
        /* Variáveis CSS para cores do tema */
        :root {
            --skyrim-gold: #c4ad33;
            --skyrim-bg: #1a1a1a;
            --skyrim-panel: #2a2a2a;
            --skyrim-text: #e0e0e0;
            --skyrim-red: #8b0000;
        }

        body {
            background-color: var(--skyrim-bg);
            background-image: url('https://www.transparenttextures.com/patterns/dark-matter.png'); /* Textura sutil */
            color: var(--skyrim-text);
            font-family: 'MedievalSharp', cursive;
            margin: 0;
            display: flex;
            flex-direction: column;
            align-items: center;
            min-height: 100vh;
            padding: 20px;
        }

        h1, h2 {
            font-family: 'Cinzel', serif;
            text-transform: uppercase;
            letter-spacing: 3px;
            color: var(--skyrim-gold);
            text-shadow: 2px 2px 4px #000;
            margin-bottom: 20px;
        }

        .quest-log-container {
            width: 90%;
            max-width: 600px;
            background: rgba(42, 42, 42, 0.9);
            border: 2px solid #444;
            border-image: linear-gradient(to bottom, #888, #222) 1;
            padding: 20px;
            box-shadow: 0 0 20px rgba(0,0,0,0.5);
            margin-bottom: 20px;
        }

        /* Inputs e Botões */
        input[type="text"], input[type="password"] {
            width: 100%;
            background: #111;
            border: 1px solid #555;
            color: #fff;
            padding: 10px;
            font-family: 'MedievalSharp';
            margin-bottom: 10px;
        }

        button {
            background: transparent;
            color: var(--skyrim-gold);
            border: 1px solid var(--skyrim-gold);
            padding: 10px 20px;
            cursor: pointer;
            transition: 0.3s;
            text-transform: uppercase;
            font-family: 'Cinzel', serif;
            font-size: 0.9em;
        }

        button:hover {
            background: var(--skyrim-gold);
            color: #000;
            box-shadow: 0 0 10px var(--skyrim-gold);
        }

        .btn-red {
            color: var(--skyrim-red);
            border-color: var(--skyrim-red);
        }
        .btn-red:hover {
            background: var(--skyrim-red);
            color: #fff;
            box-shadow: 0 0 10px var(--skyrim-red);
        }

        .btn-small {
            padding: 5px 10px;
            font-size: 0.8em;
        }

        /* Seção de Login */
        #login-section h2 {
            text-align: center;
        }
        #login-section button {
            width: 100%;
        }

        /* Seção de Tasks */
        #task-section {
            display: none; /* Escondido por padrão, JavaScript mostra */
        }
        .header-task-section {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            border-bottom: 1px solid #444;
            padding-bottom: 10px;
        }
        .user-info {
            font-size: 0.9em;
            color: #aaa;
        }
        .add-task-group {
            display: flex;
            gap: 10px;
            margin-bottom: 30px;
        }
        .add-task-group input {
            flex-grow: 1;
            margin-bottom: 0;
        }

        /* Lista de Tarefas */
        .task-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px;
            border-left: 3px solid transparent;
            transition: 0.2s;
            border-bottom: 1px solid #333;
            background: rgba(0,0,0,0.1);
            margin-bottom: 5px;
        }
        .task-item:hover {
            border-left: 3px solid var(--skyrim-gold);
            background: rgba(255,255,255,0.05);
        }
        .task-item.completed {
            border-left-color: #006400; /* Verde escuro para concluídas */
        }
        .task-title {
            font-size: 1.2rem;
            cursor: pointer; /* Para marcar como concluída */
            flex-grow: 1;
            margin-right: 10px;
        }
        .task-title.done {
            text-decoration: line-through;
            color: #666;
        }
        .task-actions {
            display: flex;
            gap: 5px;
        }
    </style>
</head>
<body>
    <h1>Skyrim Quest Log</h1>

    <div class="quest-log-container">
        <div id="login-section">
            <h2>Enter the Elder Scrolls</h2>
            <input type="text" id="username" placeholder="Dragonborn Name">
            <input type="password" id="password" placeholder="Shout Password">
            <button onclick="login()">Login</button>
            <p id="login-error" style="color: var(--skyrim-red); text-align: center; margin-top: 10px;"></p>
        </div>

        <div id="task-section">
            <div class="header-task-section">
                <h2>Your Quests</h2>
                <div class="user-info">
                    <span>Logged in as: <strong id="logged-in-user">Guest</strong></span>
                    <button onclick="logout()" class="btn-small btn-red" style="margin-left: 10px;">Logout</button>
                </div>
            </div>

            <div class="add-task-group">
                <input type="text" id="task-title" placeholder="New Quest Title...">
                <button onclick="createTask()">Add Quest</button>
            </div>

            <ul id="task-list">
                </ul>
        </div>
    </div>

    <script>
        // Configurações Globais
const API_URL = "http://localhost:8080"; 
let token = localStorage.getItem("token");
let currentUsername = localStorage.getItem("username");

// --- Inicialização ---
document.addEventListener('DOMContentLoaded', () => {
    console.log("Sistema iniciado. Token atual:", token);
    if (token && currentUsername) {
        showTasksSection(currentUsername);
    } else {
        showLoginSection();
    }
});

// --- Controle de Interface (O "Redirecionamento" SPA) ---
function showLoginSection() {
    document.getElementById("login-section").style.display = 'block';
    document.getElementById("task-section").style.display = 'none';
}

function showTasksSection(username) {
    console.log("Trocando para tela de tarefas...");
    document.getElementById("login-section").style.display = 'none';
    document.getElementById("task-section").style.display = 'block';
    document.getElementById("logged-in-user").innerText = username;
    loadTasks();
}

// --- Lógica de Autenticação ---
async function login() {
    const usernameInput = document.getElementById("username").value;
    const passwordInput = document.getElementById("password").value;
    const errorDisplay = document.getElementById("login-error");

    errorDisplay.innerText = ""; 

    try {
        const res = await fetch(`${API_URL}/login`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ username: usernameInput, password: passwordInput })
        });

        const data = await res.json();

        if (res.ok) {
            console.log("Resposta da API:", data);
            
            // Tenta capturar o token independente da capitalização (Token ou token)
            token = data.token || data.Token; 

            if (!token) {
                errorDisplay.innerText = "Erro: Token não recebido do servidor.";
                console.error("Campo 'token' ausente no JSON de resposta.");
                return;
            }

            localStorage.setItem("token", token);
            localStorage.setItem("username", usernameInput);
            
            showTasksSection(usernameInput);
        } else {
            errorDisplay.innerText = data.error || "Credenciais inválidas, Dragonborn.";
        }
    } catch (error) {
        errorDisplay.innerText = "Falha na conexão com o servidor.";
        console.error("Erro de rede:", error);
    }
}

function logout() {
    localStorage.clear();
    location.reload(); // Recarrega para limpar todos os estados
}

// --- Lógica de Quests (CRUD) ---
async function loadTasks() {
    try {
        const res = await fetch(`${API_URL}/tasks/`, {
            headers: { "Authorization": `Bearer ${token}` }
        });

        if (res.status === 401) return logout();

        const tasks = await res.json();
        const taskList = document.getElementById("task-list");
        taskList.innerHTML = ""; 

        tasks.forEach(t => {
            const listItem = document.createElement('li');
            listItem.className = `task-item ${t.done ? 'completed' : ''}`;
            listItem.innerHTML = `
                <span class="task-title ${t.done ? 'done' : ''}" onclick="toggleTaskStatus(${t.ID}, ${t.done})">
                    ${t.title}
                </span>
                <div class="task-actions">
                    <button onclick="deleteTask(${t.ID})" class="btn-small btn-red">X</button>
                </div>
            `;
            taskList.appendChild(listItem);
        });
    } catch (error) {
        console.error("Erro ao carregar tarefas:", error);
    }
}

async function createTask() {
    const titleInput = document.getElementById("task-title");
    if (!titleInput.value) return;

    await fetch(`${API_URL}/tasks/`, {
        method: "POST",
        headers: { 
            "Content-Type": "application/json",
            "Authorization": `Bearer ${token}` 
        },
        body: JSON.stringify({ title: titleInput.value, done: false })
    });
    titleInput.value = "";
    loadTasks();
}

async function deleteTask(id) {
    if (!confirm("Abandonar esta quest?")) return;
    await fetch(`${API_URL}/tasks/${id}`, {
        method: "DELETE",
        headers: { "Authorization": `Bearer ${token}` }
    });
    loadTasks();
}

async function toggleTaskStatus(id, currentStatus) {
    await fetch(`${API_URL}/tasks/${id}`, {
        method: "PUT",
        headers: {
            "Content-Type": "application/json",
            "Authorization": `Bearer ${token}`
        },
        body: JSON.stringify({ done: !currentStatus })
    });
    loadTasks();
}
    </script>
</body>
</html>